<div class="relative">
    <div [ngBusy]="subs">
        <div class="mini-form row">
            <div class="row">
                <label class="marginTop col-md-2 text-right">Policy </label>
                <div class="form-group col-md-2">
                    <policy-picker [policySearchString]="form?.policyId" [mode]="policyIdDisabled ? stateMode.readonly : mode" (onPolicyChange)="onPolicyChange($event)">
                    </policy-picker>
                </div>
                <ng-container *ngIf="showCps2">
                    <label class="marginTop col-md-2 text-right">CPS 2</label>
                    <div class="form-group col-md-2">
                        <select class="form-control input-sm text-left" id="cps2" name="cps2" [(ngModel)]="form.secondCpsUser" [desactive]="stepName == 'Analysis' ? stateMode.edit : stateMode.readonly">
                            <option [ngValue]="null"></option>
                            <option *ngFor="let a of usersList" [ngValue]="a.usrId">{{a.name0}}</option>
                        </select>
                    </div>
                </ng-container>                
            </div>

            <ng-container *ngIf="policy">
                <!-- Non editable section -->
                <div class="row" class="col-md-12">

                    <!-- Clients (policy holders, insured, beneficiaries, other clients, etc..)   -->
                    <div class="analysis-section">
                        <policy-clients 
                            [product]="policy.product" 
                            [policyHolders]="policy.policyHolders" 
                            [insureds]="policy.insureds" 
                            [deathBeneficiaries]="policy.deathBeneficiaries"
                            [lifeBeneficiaries]="policy.lifeBeneficiaries" 
                            [otherClients]="policy.otherClients">
                        </policy-clients>
                    </div>

                    <!-- Policy fees    -->
                    <div class="analysis-section" *ngIf="showFees">
                        <policy-fees                        
                            [contractCurrency]= "policy?.currency"
                            [valuation]="valuation"
                            [displayEntryFeesLine]="false"
                        ></policy-fees>
                    </div>                    
                </div>
            </ng-container>
        </div>

        <div class="line-break"></div>
        <div class="line-break"></div>

        <!-- Editable section -->
        <div class="mini-form row" *ngIf="showEditionSection && policy && form">
            <div class="row" class="col-md-12">
                <div class="analysis-section">
                    <div class="row">
                        <label class="marginTop col-md-2 text-right">Effective date</label>
                        <div class="form-group col-md-2">
                            <datepicker [disabled]="mode == stateMode.readonly" [(date)]="form.effectiveDate" (dateChange)="onEffectiveDateChange($event, policy.polId)"></datepicker>
                        </div>
                    </div>
                </div>
                <div class="analysis-section">
                    <fees
                        [(brokerFees)]="form.brokerTransactionFees"
                        [(fees)]="form.transactionFees"
                        [feesLabel]="'Surrender fees'"
                        [brokerFeesLabel]="'Broker surrender fees'"
                        [mode]="mode">
                    </fees>
                </div>
                <div class="analysis-section">
                    <lissia-transaction *ngIf="showTransaction; else transactionNotCreatedYetTemplate"
                        [transaction]="transaction"
                        [surrenderDetails]="surrenderDetails" 
                        [policyId]="policy?.polId">
                    </lissia-transaction>                           
                    <ng-template #transactionNotCreatedYetTemplate>
                        <fund-transaction 
                            [mode]="mode"
                            [valuation]="valuationOnDate"
                            [policyCurrency]="policy.currency"
                            [(fundTransactions)]="form.fundTransactionForms"
                            [showSectionTitle]="false"                        
                        ></fund-transaction>
                    </ng-template>                    
                </div>                
                <div class="analysis-section">
                    <securities-transfers *ngIf="showSecuritiesTransfer && form.paymentType === paymentType.SECURITY_TRANSFER"
                        [mode]="securitiesTransferMode"
                        [transferCandidates]="transferCandidates"
                        [securitiesTransfers]="form.securitiesTransfer">
                    </securities-transfers>
                </div>
                <div class="analysis-section">
                    <cash-transfers *ngIf="showCashTransfer"
                        [currencyList]="currencyList"
                        [transferCandidates]="transferCandidates"
                        [mode]="paymentsMode"
                        (onAddPayment)="onAddPaymentEvent()"
                        [(payments)]="form.payments">
                    </cash-transfers>
                </div>                
            </div>
        </div>
</div>