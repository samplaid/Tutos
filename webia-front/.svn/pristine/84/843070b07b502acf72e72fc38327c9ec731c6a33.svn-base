<ng-template ngbModalContainer></ng-template>

<div class="split-screen relative" >
  <div [ngBusy]="[busy,busyLoad, busySave,busyReject, busyCancel, busyGenerateDocumentation, busyRecreate]">
    <div class="row">
        <div class="col-xs-12">
            <div class="row">
                <div class="col-md-1 text-right">
                    <button class="btn btn-nav" id="previous" (click)="reasonReject()" [disabled]="(step?.stepRejectable!=true || (step && step.workFlowStatus == 3) || (step && step.workFlowStatus == 4))" [desactive]="mode" title="Reject step">
                        <i class="fa fa-chevron-left" aria-hidden="true"></i>
                        <i class="fa fa-chevron-left" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="col-md-10 menu">
                    <div class="col-md-1 nopadding">
                        <img alt="Wealins" src="./assets/img/wealins-logo-flat.png" class="pull-left marginTop" width="120">
                    </div>
                    <div class="col-md-2 marginTop3">
                        <div class="row">
                            <div class="form-inline">
                                <label><b>Subscription</b></label> <span>{{step?.workflowItemId}}</span>
                                <span class="paddingLeft10">
                                    <span class="label label-primary w-label" *ngIf="step && step.workFlowStatus == 1">Active</span>
                                    <span class="label label-primary w-label" *ngIf="step && step.workFlowStatus == 2">Suspended</span>
                                    <span class="label label-primary w-label" *ngIf="step && step.workFlowStatus == 3">Completed</span>
                                    <span class="label label-primary w-label" *ngIf="step && step.workFlowStatus == 4">Ended</span>
                                    <span class="label label-primary w-label" *ngIf="step && step.workFlowStatus == 5">Locked</span>
                                </span>
                            </div>                           
                        </div>
                        <div class="row" *ngIf="step?.firstCpsUser">
                            <label><b>CPS 1</b></label> {{firstCpsUser?.name0}}
                        </div>
                    </div>
                    <div class="col-md-2 marginTop3">
                        <div class="row">
                            <label><b>Policy</b></label> 
                            <a *ngIf="showPolicyLink && step" href="./#/policy?id={{step?.polId}}"  target="_blank">{{step?.polId}}</a>                            
                            <span *ngIf="!showPolicyLink">{{step?.polId}}</span>
                        </div>
                        <div class="row" *ngIf="step?.secondCpsUser">
                            <label><b>CPS 2</b></label> {{secondCpsUser?.name0}}
                        </div>
                    </div>                      
                    <div class="col-md-2 marginTop3">
                        <div class="row">
                            <label><b>Application Nr</b></label> {{step?.applicationForm}}
                        </div>
                        <div class="row" *ngIf="step?.assignedTo">
                            <label><b>Assigned to</b></label> {{step?.assignedTo}}
                        </div>                           
                    </div>        
                    <div class="col-md-2 marginTop3">
                         <div>{{step?.productCd}} {{step?.productName}}</div>
                    </div> 
                    <div class="col-md-3 paddingVertical2 paddingLeft text-right">
                        <button class="btn btn-xs btn-default" (click)="addComment()"><i class="fa fa-comments-o" aria-hidden="true"></i> Comment</button>
                        <button *ngIf="canSendProgressStatusMail" class="btn btn-xs btn-default" (click)="sendSourcriptionFollowUpMail()" [desactive]="mode"><i class="fa fa-envelope" aria-hidden="true" ></i> Send</button>
                        <button *ngIf="canPrintAcceptanceReport" class="btn btn-xs btn-default" (click)="printAcceptanceReport()" [desactive]="mode"><i class="fa fa-print" aria-hidden="true" ></i> Acceptance</button>
                        <button *ngIf="canGenerateDocumentation" class="btn btn-xs btn-default" (click)="generateDocumentation()" [desactive]="mode"><i class="fa fa-print" aria-hidden="true" ></i> Documentation</button>
                        <button *ngIf="canSave" class="btn btn-xs btn-primary" (click)="save(false)" [desactive]="mode"><i class="fa fa-floppy-o" aria-hidden="true"></i> Save</button>       
                        <button *ngIf="canAbort" class="btn btn-xs btn-default" (click)="cancel()" [desactive]="mode"><i class="fa fa-trash" aria-hidden="true" ></i> Abort</button>
                        <button *ngIf="canRecreate" class="btn btn-xs btn-default" (click)="recreate()" [desactive]="mode"><i class="fa fa-undo" aria-hidden="true" ></i> Recreate</button>                        
                    </div> 
                </div>
                <div class="col-md-1">
                    <button class="btn btn-nav" id="next" (click)="save(true)" [disabled]="(mode == stateMode.readonly || mode == stateMode.waiting || (step && step.workFlowStatus == 3) || (step && step.workFlowStatus == 4))" title="Finalise step">
                        <i class="fa fa-chevron-right" aria-hidden="true"></i>
                        <i class="fa fa-chevron-right" aria-hidden="true"></i>
                    </button>
                </div>    
            </div>
            <div *ngIf="commentsData?.length>0 || rejectData?.length>0">
                <div class="col-xs-8"></div>
                <a [ngClass]="{'invisible' :!commentsData || commentsData.length==0}" id="comment-history" class="btn btn-primary col-xs-2 history-tab" (click)="showCommentsHistory()">Comment History <span class="badge">{{commentsData?.length}}</span></a>
                <a [ngClass]="{'invisible' :!rejectData || rejectData.length==0}" id="reject-history" class="btn btn-danger col-xs-2 history-tab" (click)="showRejectHistory()">Reject History <span class="badge">{{rejectData?.length}}</span></a>  
            </div>
            <div [ngClass]="{'line-break-big': commentsData?.length==0 && rejectData?.length==0}" class="col-xs-12 line-break"></div>
        </div>
    </div>

    <div class="col-xs-12 paddingHorizontal12">
            <ngbd-alert-container ref="global"></ngbd-alert-container>
            <ngbd-alert-container ref="rejectHistory"></ngbd-alert-container>
            <div class="row">
                <div class="ngbd-alert-container" [ngClass]="{'col-md-12' : (!showStepComments || commentsData?.length==0) , 'col-md-3 paddingRight' : (showCommentForm && showStepComments && commentsData?.length>0)}">    
                    <div class="row alert alert-default nomargin animated bounceIn" [ngClass]="{'bounceOutLeft': commentFormClosing}" *ngIf="showCommentForm">
                        <div class="pull-right"> <button aria-label="Close" class="close" type="button" (click)="closeCommentForm()">Ã—</button></div>
                        <label [ngClass]="{'col-md-1 text-right' : (!showStepComments || commentsData?.length==0)}" class="paddingHorizontal3 paddingTop2">Comment</label>
                        <div [ngClass]="{'col-md-6' : (!showStepComments || commentsData?.length==0)}" class="paddingHorizontal3"><textarea  autosize class="form-control paddingVertical" maxlength="1000" [(ngModel)]='commentToAdd' rows="3"> </textarea></div>
                        <div [ngClass]="{'col-md-4' : (!showStepComments || commentsData?.length==0)}" class="">
                            <label [ngClass]="{'col-md-4 text-right' : (!showStepComments || commentsData?.length==0)}" class="paddingHorizontal3 paddingTop2">Next Due Date</label>
                            <div [ngClass]="{'col-md-8' : (!showStepComments || commentsData?.length==0)}" class="paddingHorizontal3">
                                <div>
                                    <datepicker [(date)]="nextDueDate" [minDate]="today"></datepicker>
                                </div>
                                <div class="marginTop4">
                                    <button class="btn btn-xs btn-default" (click)="addStepComment(commentToAdd, nextDueDate)" [disabled]="nextDueDate && !commentToAdd">
                                        <i class="fa fa-floppy-o" aria-hidden="true"></i> Save Comment
                                    </button> 
                                </div>              
                            </div>
                        </div>
                    </div>
                </div>
                <div [ngClass]="showCommentForm ? 'col-md-9 paddingLeft' :  'col-md-12' ">  
                    <ngbd-alert-container ref="commentsHistory" (onClose)="showStepComments = false"></ngbd-alert-container>
                </div>
            </div>
    </div>

    <div class="row" *ngIf="step && step.formData">
        <div class="col-xs-7 form-horizontal" [ngSwitch]="step.stepWorkflow">
                <registration *ngSwitchCase="StepName.Registration" [(registration)]="step.formData" [mode]="mode"></registration>
                <waiting-dispatch *ngSwitchCase="StepName.Waiting_Dispatch" [(dispatch)]="step.formData" [mode]="mode"></waiting-dispatch>
                <generate-mandat-de-gestion *ngSwitchCase="StepName.Generate_Mandat_de_Gestion" [(generate)]="step.formData" [mode]="'readOnly'"></generate-mandat-de-gestion>
                <registration *ngSwitchCase="StepName.New_Business" [(registration)]="step.formData" [mode]="'waiting'"></registration>
                
                <analysis *ngSwitchCase="StepName.Unblocked_Analysis" [(analysis)]="step.formData" [productCd]="step.formData.productCd" [mode]="mode" [stepName]="step.stepWorkflow"></analysis>
                <analysis *ngSwitchCase="StepName.Analysis" [(analysis)]="step.formData" [productCd]="step.formData.productCd" [mode]="mode" [stepName]="step.stepWorkflow"></analysis>
                <analysis *ngSwitchCase="StepName.Account_Opening_Request" [(analysis)]="step.formData" [productCd]="step.formData.productCd" [mode]="mode" [stepName]="step.stepWorkflow"></analysis>
                <analysis *ngSwitchCase="StepName.Awaiting_Account_Opening" [(analysis)]="step.formData" [productCd]="step.formData.productCd" [mode]="mode" [stepName]="step.stepWorkflow"></analysis>
                <analysis *ngSwitchCase="StepName.Premium_Transfer_Request" [(analysis)]="step.formData" [productCd]="step.formData.productCd" [mode]="mode" [stepName]="step.stepWorkflow"></analysis>

                <analysis *ngSwitchCase="StepName.Awaiting_Premium" [(analysis)]="step.formData" [productCd]="step.formData.productCd" [mode]="'waiting'" [stepName]="step.stepWorkflow"></analysis>
                <analysis *ngSwitchCase="StepName.Premium_input_and_nav" [(analysis)]="step.formData" [productCd]="step.formData.productCd" [mode]="'waiting'" [stepName]="step.stepWorkflow"></analysis>
                <analysis *ngSwitchCase="StepName.Update_Input" [(analysis)]="step.formData" [productCd]="step.formData.productCd" [mode]="mode" [stepName]="step.stepWorkflow"></analysis>
                
                <!-- default -->
                <analysis *ngSwitchDefault [(analysis)]="step.formData" [productCd]="step.formData.productCd" [mode]="'readOnly'" [stepName]="step.stepWorkflow"></analysis>
        </div>
        <div class="col-xs-5 paddingLeft">
            <survey [inputData]="step.checkSteps"  [workflowItemId]="step.workflowItemId" [stepWorkflow]="step.stepWorkflow" [mode]="mode"></survey>
        </div>
    </div>
  </div>
</div>
