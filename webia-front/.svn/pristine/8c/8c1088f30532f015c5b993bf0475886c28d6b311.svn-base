<div class="relative">
    <div [ngBusy]="subs">
        <div class="mini-form row">
            <div class="row">
                <label class="marginTop col-md-2 text-right">Policy </label>
                <div class="form-group col-md-2">
                    <policy-picker [policySearchString]="form?.policyId" [mode]="policyIdDisabled ? stateMode.readonly : mode" (onPolicyChange)="onPolicyChange($event)">
                    </policy-picker>
                </div>
                <ng-container *ngIf="showCps1">
                    <label class="marginTop col-md-2 text-right">CPS 1</label>
                    <div class="form-group col-md-2">
                        <select class="form-control input-sm text-left" id="cps1" name="cps1" [(ngModel)]="form.firstCpsUser" [desactive]="cpsMode">
                            <option [ngValue]="null"></option>
                            <option *ngFor="let a of usersList" [ngValue]="a.usrId">{{a.name0}}</option>
                        </select>
                    </div>
                </ng-container>
                <ng-container *ngIf="showCps2">
                    <label class="marginTop col-md-2 text-right">CPS 2</label>
                    <div class="form-group col-md-2">
                        <select class="form-control input-sm text-left" id="cps2" name="cps2" [(ngModel)]="form.secondCpsUser" [desactive]="cpsMode">
                            <option [ngValue]="null"></option>
                            <option *ngFor="let a of usersList" [ngValue]="a.usrId">{{a.name0}}</option>
                        </select>
                    </div>
                </ng-container>
            </div>
            <ng-container *ngIf="policy && entryFees && valuation">
                <!-- Non editable section -->
                <div class="row" class="col-md-12">

                    <!-- Clients (policy holders, insured, beneficiaries, other clients, etc..)   -->
                    <policy-clients
                        [product]="policy.product"
                        [policyHolders]="policy.policyHolders"
                        [insureds]="policy.insureds"
                        [deathBeneficiaries]="policy.deathBeneficiaries"
                        [lifeBeneficiaries]="policy.lifeBeneficiaries"
                        [otherClients]="policy.otherClients">
                    </policy-clients>
                </div>

                <!-- Policy fees    -->
                <div class="row" class="col-md-12">
                    <policy-fees
                        [entryFees]= "entryFees.entryFees"
                        [isFeesPercentage]="entryFees.isPercentage"
                        [brokerEntryFees]= "entryFees.brokerEntryFees"
                        [contractCurrency]= "policy.currency"
                        [valuation]="valuation"
                    ></policy-fees>
                </div>

            </ng-container>
        </div>
        <div class="line-break"></div>
        <div class="line-break"></div>

        <!-- Editable section -->
        <div class="mini-form row" *ngIf="showEditionSection">

            <ng-container *ngIf="showRegistrationSection">
                <registration-invest  [(model)]="form.fundForms" [defaultCurrency]="form.contractCurrency" [formId]="form.formId" [mode]="mode"></registration-invest>
            </ng-container>

            <!-- Premium and Fees section -->
            <div class="col-md-12" *ngIf="showFeesSection">
                <policy-premium-fees *ngIf="form.broker"
                        [hasBroker]="true"
                        [showTax]="form.tax"
                        [(entryFeesPct)]= "form.entryFeesPct"
                        [(entryFeesAmt)]= "form.entryFeesAmt"
                        [(brokerEntryFeesAmt)]= "form.broker.entryFeesAmt"
                        [(brokerEntryFeesPct)]= "form.broker.entryFeesPct"
                        [currencyList]= "currencyList"
                        [(contractCurrency)]= "form.contractCurrency"
                        [(taxRate)]= "form.taxRate"
                        [(expectedPremium)]="form.expectedPremium"              
                       [mode]= "mode">                                      
               </policy-premium-fees>
               <policy-premium-fees *ngIf="!form.broker"
                        [showTax]="form.tax"
                        [(entryFeesPct)]= "form.entryFeesPct"
                        [(entryFeesAmt)]= "form.entryFeesAmt"
                        [currencyList]= "currencyList"
                        [(contractCurrency)]= "form.contractCurrency"
                        [(taxRate)]= "form.taxRate"
                        [(expectedPremium)]="form.expectedPremium"              
                       [mode]= "mode">                                      
               </policy-premium-fees>
            </div>

            <!-- Investment section -->
            <div class="col-md-12" *ngIf="showInvestmentSection">
                <analysis-invest [(fundForms)]="form.fundForms"
                                    [stepName]="stepName"
                                    [valuationDate]="form.paymentDt"
                                    [formId]="form.formId" 
                                    [broker]="form.broker" 
                                    [mode]="mode" 
                                    [currency]="form.contractCurrency"
                                    [totalInvestment] = "form.paymentAmt"
                                    [generateMandatDeGestion]="generateMandatDeGestion"
                                    [showValuationAmount]="showValuationAmount"
                                    [undeletableFundIds]="undeletableFundIds"
                                    (fundFormsChange)="refreshSurvey()"
                                    (generateMandateChange)="applyManagementMandateDocRequest($event)" >
                </analysis-invest>                
            </div>

            <!-- Payment section -->
            <div class="col-md-12"  *ngIf="showPaymentSection">
                <payment
                    [(premiumCountryCd)]="form.premiumCountryCd"
                    [(paymentTransfer)]="form.paymentTransfer"
                    [(policyTransferForms)]="form.policyTransferForms"
                    [(policyTransfer)]="form.policyTransfer"
                    [(paymentAmt)]="form.paymentAmt"
                    [paymentDt]="form.paymentDt"
                    (paymentDtChange)="onPaymentDtChange($event)"
                    [expectedPremium]="form.expectedPremium"
                    [contractCurrency]="form.contractCurrency"
                    [mode]="paymentMode"
                    [transfertMode]="mode"
                ></payment>           
            </div>
    </div>
</div>